<template>
    <div v-if="editor">
      <div class="space-x-2 px-3 py-3 flex items-center border border-b-0 rounded-t border-gray-300 dark:border-white"
      :class="buttonClasses">
          <div v-for="btn in buttons" :key="btn" @click="actionMap[btn.action].action()" :class="actionMap[btn.action].isActive ? { 'is-active': editor.isActive(...actionMap[btn.action].isActive) } : {}" class="flex items-center text-1 icon-button">
              <i :class="btn.icon" v-tippy="{ content: btn.content }"></i>
          </div>
      </div>

      <editor-content :editor="editor">
      </editor-content>

      <div v-if="charCount" class="mt-1" :class="{'character-count': charCount, 'character-count--warning': editor.getCharacterCount() === charCountLimit}">
        <svg
          height="20"
          width="20"
          viewBox="0 0 20 20"
          class="character-count__graph"
        >
          <circle
            r="10"
            cx="10"
            cy="10"
            fill="#e9ecef"
          />
          <circle
            r="5"
            cx="10"
            cy="10"
            fill="transparent"
            stroke="currentColor"
            stroke-width="10"
            :stroke-dasharray="`${circleFillCharCount()} 999`"
            transform="rotate(-90) translate(-20)"
          />
          <circle
            r="6"
            cx="10"
            cy="10"
            fill="white"
          />
        </svg>
        <div class="flex space-x-2">
          <div class="character-count__text">
            {{ editor.getCharacterCount() }}/{{ charCountLimit }} characters
          </div>
          <slot></slot>
        </div>
      </div>
    </div>
</template>

<script lang="js">
import { useEditor, EditorContent } from '@tiptap/vue-3'
import StarterKit from '@tiptap/starter-kit'
import Highlight from '@tiptap/extension-highlight'
import Typography from '@tiptap/extension-typography'
import Placeholder from '@tiptap/extension-placeholder'
import Underline from '@tiptap/extension-underline'
import CharacterCount from '@tiptap/extension-character-count'

import { defineComponent } from 'vue'

export default defineComponent({
  name: 'PostNew',
  components: {
    EditorContent
  },
  computed: {
    actionMap () {
      return {
        paragraph: {
          action: () => this.editor.chain().focus().setParagraph().run(),
          isActive: ['paragraph']
        },
        bold: {
          action: () => this.editor.chain().focus().toggleBold().run(),
          isActive: ['bold']
        },
        highlight: {
          action: () => this.editor.chain().focus().toggleHighlight().run(),
          isActive: ['highlight']
        },
        italic: {
          action: () => this.editor.chain().focus().toggleItalic().run(),
          isActive: ['italic']
        },
        underline: {
          action: () => this.editor.chain().focus().toggleUnderline().run(),
          isActive: ['underline']
        },
        strike: {
          action: () => this.editor.chain().focus().toggleStrike().run(),
          isActive: ['strike']
        },
        code: {
          action: () => this.editor.chain().focus().toggleCode().run(),
          isActive: ['code']
        },
        clearMarks: {
          action: () => this.editor.chain().focus().unsetAllMarks().run()
        },
        clearNodes: {
          action: () => this.editor.chain().focus().clearNodes().run()
        },
        h1: {
          action: () => this.editor.chain().focus().toggleHeading({ level: 1 }).run(),
          isActive: ['heading', { level: 1 }]
        },
        h2: {
          action: () => this.editor.chain().focus().toggleHeading({ level: 2 }).run(),
          isActive: ['heading', { level: 2 }]
        },
        h3: {
          action: () => this.editor.chain().focus().toggleHeading({ level: 3 }).run(),
          isActive: ['heading', { level: 3 }]
        },
        h4: {
          action: () => this.editor.chain().focus().toggleHeading({ level: 4 }).run(),
          isActive: ['heading', { level: 4 }]
        },
        h5: {
          action: () => this.editor.chain().focus().toggleHeading({ level: 5 }).run(),
          isActive: ['heading', { level: 5 }]
        },
        h6: {
          action: () => this.editor.chain().focus().toggleHeading({ level: 6 }).run(),
          isActive: ['heading', { level: 6 }]
        },
        bulletList: {
          action: () => this.editor.chain().focus().toggleBulletList().run(),
          isActive: ['bulletList']
        },
        orderedList: {
          action: () => this.editor.chain().focus().toggleOrderedList().run(),
          isActive: ['orderedList']
        },
        codeBlock: {
          action: () => this.editor.chain().focus().toggleCodeBlock().run(),
          isActive: ['codeBlock']
        },
        blockquote: {
          action: () => this.editor.chain().focus().toggleBlockquote().run(),
          isActive: ['blockquote']
        },
        horizontalRule: {
          action: () => this.editor.chain().focus().setHorizontalrule().run()
        },
        hardBreak: {
          action: () => this.editor.chain().focus().setHardBreak().run()
        },
        undo: {
          action: () => this.editor.chain().focus().undo().run()
        },
        redo: {
          action: () => this.editor.chain().focus().redo().run()
        }
      }
    }
  },
  emits: ['update:modelValue'],
  methods: {
    circleFillCharCount () {
      return (Math.round((100 / this.charCountLimit) * this.editor.getCharacterCount()) * 31.4) / 100
    },
    getJSON () {
      return this.editor.getJSON()
    }
  },
  props: {
    buttons: Array,
    buttonClasses: String,
    inputPlaceholder: String,
    charCount: Boolean,
    charCountLimit: {
      type: Number,
      default: 250
    },
    modelValue: {
      default: '',
      type: String
    }
  },
  setup (props, ctx) {
    const extensions = [
      StarterKit.configure({
        heading: {
          levels: [1, 2, 3]
        }
      }),
      Highlight,
      Typography,
      Placeholder.configure({
        placeholder: props.inputPlaceholder
      }),
      Underline
    ]

    if (props.charCount) {
      extensions.push(CharacterCount.configure({
        limit: props.charCountLimit
      }))
    }

    const editor = useEditor({
      content: props.modelValue,
      onUpdate: function () {
        ctx.emit('update:modelValue', this.getHTML())
      },
      extensions
    })

    return {
      editor
    }
  },
  watch: {
    modelValue: {
      handler (modelValue) {
        this.editor.commands.setContent(modelValue)
      }
    }
  }
})
</script>

<style lang="scss">
  @import "~@/assets/css/utils/input";
  @import "~@/assets/css/utils/box.css";
  @import "~@/assets/css/utils/button.css";

  .character-count {
    margin-top: 1rem;
    display: flex;
    align-items: center;
    color: #68CEF8;

    &--warning {
      color: #FB5151;
    }

    &__graph {
      margin-right: 0.5rem;
    }

    &__text {
      color: #868e96;
    }
  }

  /* Placeholder (at the top) */
  /* *:focus {
    outline: none !important;
  } */
  .ProseMirror p.is-editor-empty:first-child::before {
      content: attr(data-placeholder);
      float: left;
      @apply dark:text-v-placeholder-light text-v-placeholder-dark;
      pointer-events: none;
      height: 0;
  }

  .ProseMirror {
    @extend .input-border;
    @apply rounded-t-none focus:rounded-t focus:outline-none outline-none min-h-20 px-2 py-1;
    // @apply border rounded-b outline-none px-2 py-1 shadow-inner min-h-20 border-gray-300 dark:border-white
  }

  .icon-button.is-active {
    @apply bg-blue-500 border-indigo-800 dark:shadow-none;
  }
</style>
